@startuml name
title EEG-Based BCI Wheelchair Control System - Block Diagram

skinparam rectangle {
  BackgroundColor #EEF2FF
  BorderColor #334488
  RoundCorner 20
}
skinparam node {
  BackgroundColor #F8FAFF
  BorderColor #5566AA
  RoundCorner 15
}
skinparam component {
  BackgroundColor #FFFFFF
  BorderColor #777777
}
skinparam arrow {
  Thickness 2
  Color #333388
}

actor "User (Motor Imagery\n& Jaw Clench)" as User

rectangle "EEG Headset" as Headset {
  component "Electrodes (8 Ch)" as Electrodes
  node "OpenBCI Cyton Controller\n(8-Ch, 250 Hz)" as Cyton
  component "Wireless / USB Data Link\n(Bluetooth / Serial)" as Comms
  component "EEG Signal (uV level)" as EEG

  ' Data flow inside the headset
  Electrodes --> EEG : Brain activity
  EEG --> Cyton
  Cyton --> Comms : Stream Raw EEG
}

rectangle "Real-Time Motor Control\n(real_time_motor.py)" as PC {
  component "BrainFlow API\n(BoardShim)" as Brainflow
  
  rectangle "Signal Acquisition Thread\n(acquire_signals)" as AcqThread {
    component "get_current_board_data(250)\n8 channels x 250 samples\nOverlapped windows (0.5s)" as DataBuffer
  }
  
  rectangle "Compute Thread\n(compute_signals)" as CompThread {
    component "Jaw Clench Detection\n(Channel 8 / Electrode 8)\nAmplitude & Variance Threshold" as JawDetect
    
    component "Preprocessing (functions.py)\nBand-pass 8-30 Hz\nCOI3 Wavelet (order 0)\nFFT Extraction" as Preprocess
    
    component "Deep Learning Model\n(Keras CNN)\n77.5-149epoch model" as Model
    
    component "EMA Smoothing\n(alpha = 0.4)\nConfidence > 80%" as EMA
    
    component "Command Logic\nJAW CLENCH -> FORWARD\nLEFT imagery -> LEFT\nRIGHT imagery -> RIGHT\nLow confidence -> STOP" as CommandLogic
  }
  
  component "Motor Controller\n(motor_control.py)\nSerial Link to ESP32" as MotorCtrl
  
  Brainflow --> DataBuffer
  DataBuffer --> JawDetect : Raw EEG (8x250)
  JawDetect --> CommandLogic : FORWARD (priority)
  DataBuffer --> Preprocess : Raw EEG (8x250)
  Preprocess --> Model : Preprocessed Input\n(1x8x250x1)
  Model --> EMA : Probabilities [L, R]
  EMA --> CommandLogic : Predicted Action
  CommandLogic --> MotorCtrl : execute_action()
}

rectangle "Embedded Interface" as ESP {
  node "ESP32 Microcontroller" as MCU
  component "UART Receiver" as UART
  component "Motor Driver Interface\n(BTS7960 / H-Bridge)" as MotorIF
  component "Dual DC Motors / Wheel Assembly" as Motors

  MotorCtrl --> UART : Commands (W/A/D/S)
  UART --> MotorIF : PWM Direction Signals
  MotorIF --> Motors : Forward / Left / Right / Stop
}

' --- Flow Connections ---
User --> Electrodes : Imagines Hand Movement\n& Clenches Jaw
Comms --> Brainflow : Transmit Raw EEG (COM port)
Motors --> User : Physical Movement Feedback

note right of JawDetect
  **Priority Control:**
  Jaw clench bypasses neural
  network for immediate
  FORWARD response
end note

note bottom of EMA
  **Confidence Gating:**
  Raw confidence < 80% resets EMA
  EMA confidence < 80% sends STOP
end note

note right of MotorCtrl
  **Command Deduplication:**
  Only sends new commands
  when state changes
end note

@enduml
